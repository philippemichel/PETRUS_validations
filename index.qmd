---
subtitle: "Évaluation de la gaine du nerf optique par échographie dans l'Artérite à Cellules géantes"
---

:::: panel-tabset
# Introduction

::: {.callout-tip title="Évaluation de la gaine du nerf optique par échographie dans l'Artérite à Cellules géantes"}
Recherche non interventionnelle ne comportant aucun risque ni contrainte

Étude diagnostique non interventionnelle, prospective multicentrique

**Investigateur Coordonnateur** <br>Omar AL TABAA --- Rhumatologie
Hôpital NOVO (Site de Pontoise)

**Comité scientifique**<br> Maxime SANSOM --- Service de médecine
interne CHU Dijon<br> Sébastien OTTAVIANI --- Service de rhumatologie
hôpital Bichat (Paris)<br> Olivier ESPITIA --- Service de médecine
vasculaire CHU Nantes

**Chef de projet** <br>Mathilde WLODARCZY — USRC

**Méthodologiste**<br> Chrystelle VIDAL --- GIRCI Île de France

**Data-manager**<br>Nathanaël CHARRIER — USRC

**Statisticien**<br>Philippe MICHEL — USRC
:::

```{r}
#| label: setup

#
# setup
#

library(tidyverse)
library(baseph)
library(labelled)
library(readODS)
library(janitor)
library(kableExtra)
library(gtsummary)
library(plotly)

classeur <- "petrusvalid.ods"
expx <- FALSE
if (expx) {
  file.create(classeur)
  file.remove(classeur)
  write_ods(iris, classeur)
}

# sessionInfo()

theme_gtsummary_language(language = "fr", decimal.mark = ",")
theme_gtsummary_journal(journal = "jama")
options(OutDec = ",")
ptest <- list(all_continuous() ~ "t.test", all_categorical() ~ "chisq.test")
ptest2 <- list(all_continuous() ~ "paired.t.test", all_categorical() ~ "chisq.test")
stt <- list(
  all_continuous() ~ "{mean} ({sd})",
  all_categorical() ~ "{n}/{N} ({p}%)")
```

```{r}
#| label: import

#
# Importation des données 
#
library(tidyverse)
library(baseph)
library(readODS)
library(labelled)
library(janitor)
#
# Concordance intra
#

nad <- c("", " ", "NA", "ND")

intra <- read_ods("datas/concordance_intra.ods", 
                  na = nad) |> 
    clean_names() |>
  mutate(across(where(is.character), as.factor))
bn <- read_ods("datas/concordance_intra.ods", 
                sheet = 2)
var_label(intra) <- bn$titre
#
# Concordance technique
#
tech <- read_ods("datas/concordance_techniques.ods", 
                  na = nad) |> 
    clean_names() |>
  mutate(across(where(is.character), as.factor))
bn <- read_ods("datas/concordance_techniques.ods", 
                sheet = 2)
var_label(tech) <- bn$titre
#
# Validation mesures
#
tt <- read_ods("datas/validation-mesures.ods", 
                  na = nad) |> 
    clean_names() |>
  mutate(across(where(is.character), as.factor))
bn <- read_ods("datas/validation-mesures.ods", 
                sheet = 2)
var_label(tt) <- bn$titre
#

```

# Concordance intra-observateur

Les données ne sont présentes que pour un seul des experts.

On considère qu'il y a une erreur dans les mesures si la différence
entre les deux mesures est supérieure à 1 mm.

```{r}
#| label: intra-prepa
#
# Préparation des données 
#
intra2 <- intra |> 
  pivot_longer(names_to = "structure", values_to = "value", cols = nerf_droit:gaine_gauche) |> 
  pivot_wider(names_from = "relecture", values_from = "value") |> 
  ## Recodage de zz$structure
mutate(structure = fct_recode(structure,
    "gaine du nerf optique" = "gaine_droit",
    "gaine du nerf optique" = "gaine_gauche",
    "nerf optique" = "nerf_droit",
    "nerf optique" = "nerf_gauche"
  )) |> 
mutate(dif = abs( R_1 - R_2)) |> 
mutate(erreur = as.factor(ifelse(dif > 0.999,"Erreur","Correct"))) |> 
  drop_na(dif) 
intra2 <- droplevels(intra2)
var_label(intra2$dif) <-  "Différence des mesures"
var_label(intra2$erreur) <-  "Erreur de mesure"
```

```{r}
#| label: tab-intratab1
#| tab-cap: Concordance intra-observateur

tab <-intra2 |> 
dplyr::filter(structure == "nerf optique") |> 
dplyr::select(dif, erreur) |> 

 tbl_summary(missing = "no",
              type = all_continuous() ~ "continuous2",
               statistic = all_continuous() ~ c(
      "{mean} ± {sd}",
      "{min}, {max}")) |> 
  add_n() |> 
  bold_labels() |>
  modify_header(label ~ " ") |> 
   modify_spanning_header(c("stat_0") ~ "**Nerf optique**") 
  if (expx) {
      tab |>
        as_tibble() |>
        write_ods(path = classeur, sheet = "intra-tab1n", append = TRUE)
    }
tab |> 
  as_kable_extra() |> 
   kable_material(c("striped", "hover"))

intra2 |> 
dplyr::filter(structure != "nerf optique") |> 
dplyr::select( dif, erreur) |> 

tbl_summary(missing = "no",
              type = all_continuous() ~ "continuous2",
               statistic = all_continuous() ~ c(
      "{mean} ± {sd}",
      "{min}, {max}")) |> 
     modify_spanning_header(c("stat_0") ~ "**Gaine du nerf optique**") |>
  add_n() |> 
  bold_labels() |>
  modify_header(label ~ " ") 

  if (expx) {
      tab |>
        as_tibble() |>
        write_ods(path = classeur, sheet = "intra-tab1g", append = TRUE)
    }
tab |> 
  as_kable_extra() |> 
   kable_material(c("striped", "hover"))

```

La concordance des deux mesures tend à valider la qualité des mesures.
Les mesures semblent plus reproductibles pour la gaine du nerf optique
que pour le nerf optique.

```{r}
#| label: fig-intra1
#| fig-cap: Différence entre les deux mesures

intra2 |> 
  ggplot() + 
  aes(x = dif, fill = structure) |> 
  geom_density(alpha = .7) +
        labs(
      title = "Différence entre les deux mesures",
      x = "mm", 
      caption = "Différence mesure 2 / mesure 1"
    ) +
    theme_light() +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      plot.subtitle = element_text(size = 12),
      axis.title.x = element_text(size = 12),
      axis.title.y = element_blank(),
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      legend.position = "top"
    )
```

```{r}

#| label: fig-intra2
#| fig-cap: Différence entre les deux mesures

zz <- intra2 |> 
  ggplot() + 
  aes(x = structure, y = dif, fill = structure) |> 
  geom_violin() +
        labs(
      title = "Différence entre les deux mesures",
      x = "Structure", 
      y ="mm",
      caption = "Différence mesure 2 / mesure 1"
    ) +
    theme_light() +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      plot.subtitle = element_text(size = 12),
      axis.title.x = element_text(size = 12),
      axis.title.y = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      legend.position = "none"
    )

ggplotly(zz)
```

# Concordance technique

On compare ici deux méthode de mesure : technique habituelle vs mesure à
l'interface du vitré.

```{r}
#| label: tech-prepa

#
# Concordance technique :préparation des données
#
tech2 <- tech |> 
  pivot_longer(names_to = "structure", values_to = "value", cols = nerf_droit:gaine_gauche) |> 
  pivot_wider(names_from = "technique", values_from = "value") |> 
  mutate(structure = fct_recode(structure,
                                "gaine du nerf optique" = "gaine_droit",
                                "gaine du nerf optique" = "gaine_gauche",
                                "nerf optique" = "nerf_droit",
                                "nerf optique" = "nerf_gauche"
  )) |> 
  mutate(dif = abs(habituelle -`Interface vitré`)) |> 
  mutate(erreur = as.factor(ifelse(dif > 0.999,"Erreur","Correct"))) |> 
  drop_na(dif)
var_label(tech2$dif) <-  "Différence des mesures"
```

```{r}
#| label: tab-tech1
#| tab-cap: Concordance technique

cot <- rep(c("d","d","g","g"),20)

 zz <- tech2 |> 
dplyr::filter(structure == "nerf optique") |> 
mutate(id = as.factor(paste0(centre, expert,coupe))) |> 
dplyr::select(id, habituelle:`Interface vitré`) |> 
pivot_longer(cols = habituelle :`Interface vitré`)  |> 
mutate(id = paste0(id,cot)) |> 
mutate(name = as.factor(name)) |> 
drop_na() 
tab <- zz |> 
  tbl_summary(by = name, 
              include = -id,
              type = all_continuous() ~ "continuous2",
               statistic = all_continuous() ~ c(
      "{mean} ± {sd}",
      "{min}, {max}")) |> 
  add_p(test = list(
          all_continuous() ~ "paired.t.test"),
        group = id) |> 
    add_n() |> 
  bold_labels() |>
  bold_p() |> 
  modify_header(label ~ "**Nerf optique**") 
  if (expx) {
      tab |>
        as_tibble() |>
        write_ods(path = classeur, sheet = "tab-tech1n", append = TRUE)
    }
tab |> 
  as_kable_extra() |> 
   kable_material(c("striped", "hover"))



zg <- tech2 |> 
dplyr::filter(structure != "nerf optique") |> 
mutate(id = as.factor(paste0(centre, expert,coupe))) |> 
dplyr::select(id, habituelle:`Interface vitré`) |> 
pivot_longer(cols = habituelle :`Interface vitré`)  |> 
mutate(id = paste0(id,cot)) |> 
mutate(name = as.factor(name)) |> 
drop_na() 
tab <- zg |> 
  tbl_summary(by = name, 
              include = -id,
              type = all_continuous() ~ "continuous2",
               statistic = all_continuous() ~ c(
      "{mean} ± {sd}",
      "{min}, {max}")) |> 
  add_p(test = list(
          all_continuous() ~ "paired.t.test"),
        group = id) |> 
      add_n() |> 
  bold_labels() |>
  bold_p() |> 
  modify_header(label ~ "**Gaine du nerf optique**") 

  if (expx) {
      tab |>
        as_tibble() |>
        write_ods(path = classeur, sheet = "tab-tech1g", append = TRUE)
    }
tab |> 
  as_kable_extra() |> 
   kable_material(c("striped", "hover"))


```

```{r}
#| label: tab-techvar
#| tab-cap: "Concordance technique (comparaison des variances)"


vvn <- var.test(zz$value~zz$name, alternative ="two.sided")
vvn <- beaup(vvn$p.value, affp = 1)

vvg <- var.test(zg$value~zg$name, alternative ="two.sided")
vvg <- beaup(vvg$p.value, affp = 1)

mesure = c("Nerf optique", "Gaine du nerf optique")
pvalue <- c(vvn, vvg)
             
vv <- tibble(mesure, pvalue) 

names(vv)[2] <- "Comparaison des variances"

  if (expx) {
      vv |>
        as_tibble() |>
        write_ods(path = classeur, sheet = "tab-echvar", append = TRUE)
    }
vv |> 
kbl() |>  
  kable_material(c("striped", "hover"))
```

Pour la mesure du nerf optique la technique `à l'interface vitrée` a tendance est être plus petite que la mesure `habituelle`. Pas de
différence pour la mesure de la gaine.Mais la précision est la même, il
n'y a pas de différence entre les variances des deux méthodes.

## Selon l'expert

Il n'y a aucune mesure utilisable pour le Dr OTTAVIANI.

```{r}
#| label: tab-techexp
#| tab-cap: "Différence des mesures entre les deux méthodes selon l'expert"

tab <- tech2 |> 
  dplyr::filter(structure == "nerf optique") |> 
dplyr::filter(expert != "OTTAVIANI") |> 
mutate(expert = factor(expert)) |>
  drop_na() |>
 dplyr::select(expert,dif) |> 
  tbl_summary(by = expert,
type = all_continuous() ~ "continuous2",
               statistic = all_continuous() ~ c(
      "{mean} ± {sd}",
      "{min}, {max}")) |> 
 add_p(test = list(
          all_continuous() ~ "t.test")) |> 
      add_n() |> 
  bold_labels() |>
  bold_p() |> 
  modify_header(label ~ "**Nerf optique**") 
  if (expx) {
      tab |>
        as_tibble() |>
        write_ods(path = classeur, sheet = "techexpn", append = TRUE)
    }
tab |> 
  as_kable_extra() |> 
   kable_material(c("striped", "hover"))


tab <- tech2 |> 
  dplyr::filter(structure != "nerf optique") |> 
dplyr::filter(expert != "OTTAVIANI") |> 
mutate(expert = factor(expert)) |>
  drop_na() |>
 dplyr::select(expert,dif) |> 
  tbl_summary(by = expert,
type = all_continuous() ~ "continuous2",
               statistic = all_continuous() ~ c(
      "{mean} ± {sd}",
      "{min}, {max}")) |> 
 add_p(test = list(
          all_continuous() ~ "t.test")) |> 
      add_n() |> 
  bold_labels() |>
  bold_p() |> 
  modify_header(label ~ "**Gaine du nerf optique**") 
  if (expx) {
      tab |>
        as_tibble() |>
        write_ods(path = classeur, sheet = "techexpg", append = TRUE)
    }
tab |> 
  as_kable_extra() |> 
   kable_material(c("striped", "hover"))
```

# Validation des lecteurs

On compare ici les mesures de chaque lecteur avec la moyenne des trois
experts.

```{r}
#| label: moyenne des experts

exp <- tt |> 
  drop_na() |> 
  dplyr::filter(lecteur != "échographiste formé") |> 
  pivot_longer(cols = nerf_droit:gaine_gauche,values_to = "mesure") |> 
 mutate(coupe2= paste0(coupe, name)) |>  
group_by(coupe2) |> 
  summarise(round(mean(mesure),2))

lect <- tt |> 
  dplyr::filter(lecteur == "échographiste formé") |> 
    pivot_longer(cols = nerf_droit:gaine_gauche,values_to = "mesure") |> 
 mutate(coupe2= paste0(coupe, name))

el <- left_join(exp,lect, by = "coupe2") |> 
  dplyr::select(- c(coupe2, lecteur, coupe)) 

names(el) <- c("moy_exp",  "structure", "mes_lecteur")

el <- el |> 
  mutate(dif = round(abs(moy_exp - mes_lecteur),2)) |> 
  mutate(erreur = as.factor(ifelse(dif > 0.999, "Erreur", "Correct"))) |> 
mutate(structure = fct_recode(structure,
    "Gaine du nerf optique" = "gaine_droit",
    "Gaine du nerf optique" = "gaine_gauche",
    "Nerf optique" = "nerf_droit",
    "Nerf optique" = "nerf_gauche"
  )) |> 
relocate(structure, .before = moy_exp)

var_label(el) <-  c("Structure", "Moyenne des experts", "Mesure du lecteur" ,"Différence", "Validation")
```


```{r}
#| label: tab-vallect
#| tab-cap: Validation du lecteur

tab <- el |> 
mutate(dif = cell_spec(dif, color = ifelse(dif > 0.999, "red", "black"))) |> 
  mutate(erreur = cell_spec(erreur, color = ifelse(erreur =="Erreur", "red", "black"))) 
  if (expx) {
      tab |>
        write_ods(path = classeur, sheet = "vallect", append = TRUE)
    }
tab |> 
  kbl(escape = F) |>
   kable_material(c("striped", "hover"))
```

Le lecteur testé ici a fait une erreur sur quarante mesures.
::::
